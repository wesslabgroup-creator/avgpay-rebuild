import { Handler } from '@netlify/functions'\nimport { google } from 'googleapis'\nimport { PrismaClient } from '@prisma/client'\n\nconst prisma = new PrismaClient()\n\nconst GA4_PROPERTY_ID = process.env.GA4_PROPERTY_ID_AVGPAY || 'GA4_PROPERTY_ID_AVGPAY'\n\nexport const handler: Handler = async (event, context) => {\n  if (event.httpMethod !== 'POST') {\n    return { statusCode: 405, body: 'Method Not Allowed' }\n  }\n\n  try {\n    const auth = new google.auth.OAuth2({\n      clientId: process.env.GOOGLE_CLIENT_ID,\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET,\n      refreshToken: process.env.GOOGLE_REFRESH_TOKEN,\n    })\n\n    const authClient = await auth.getClient()\n    const analyticsdata = google.analyticsdata({ version: 'v1beta', auth: authClient })\n\n    const res = await analyticsdata.properties.runReport({\n      property: `properties/${GA4_PROPERTY_ID}`,\n      requestBody: {\n        dateRanges: [\n          {\n            startDate: 'yesterday',\n            endDate: 'yesterday'\n          }\n        ],\n        metrics: [\n          { name: 'newUsers' },\n          { name: 'activeUsers' },\n          { name: 'sessions' },\n          { name: 'views' }\n        ]\n      }\n    })\n\n    const rows = res.data.rows || []\n    if (rows.length > 0) {\n      const row = rows[0] // Single day\n      const dateStr = row.dimensionValues[0]?.value || new Date().toISOString().split('T')[0]\n      const date = new Date(dateStr)\n      const values = row.metricValues.reduce((acc, m) => {\n        acc[m.name] = parseInt(m.value) || 0\n        return acc\n      }, {})\n\n      await prisma.metrics.upsert({\n        where: {\n          date_source: {\n            date,\n            source: 'GA4'\n          }\n        },\n        update: {\n          usersNew: values.newUsers,\n          usersTotal: values.activeUsers,\n          sessions: values.sessions,\n          pageviews: values.views,\n          createdAt: new Date()\n        },\n        create: {\n          date,\n          source: 'GA4',\n          usersNew: values.newUsers,\n          usersTotal: values.activeUsers,\n          sessions: values.sessions,\n          pageviews: values.views\n        }\n      })\n    }\n\n    await prisma.$disconnect()\n    return {\n      statusCode: 200,\n      body: JSON.stringify({ success: true, processed: rows.length })\n    }\n  } catch (error) {\n    console.error(error)\n    await prisma?.$disconnect()\n    return {\n      statusCode: 500,\n      body: JSON.stringify({ error: error.message })\n    }\n  }\n}